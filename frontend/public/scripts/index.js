var f=(t,e,n)=>new Promise((o,d)=>{var i=a=>{try{r(n.next(a));}catch(p){d(p);}},m=a=>{try{r(n.throw(a));}catch(p){d(p);}},r=a=>a.done?o(a.value):Promise.resolve(a.value).then(i,m);r((n=n.apply(t,e)).next());});var s=t=>{let e=document.getElementById(t);if(!e)throw new Error(`Element with id "${t}" not found`);return e},c=(t,e)=>{let n=s("modal-title"),o=s("modal-content");n.innerText=t,o.innerHTML=e,document.getElementsByClassName("modal-backdrop fade show").length||(new bootstrap.Modal("#modal").show(),setTimeout(()=>{s("modal-button").focus();},200));},u={success:t=>{c("\u6210\u529F",t.data.data);},failed:t=>e=>{if(axios.isAxiosError(e)&&e.response){let n=t==null?void 0:t[e.response.status];n?n instanceof Function?c("\u932F\u8AA4",n(e.response.data)):c("\u932F\u8AA4",n):e.response.status===401&&(alert("\u767B\u5165\u903E\u6642\uFF0C\u8ACB\u91CD\u65B0\u767B\u5165"),window.location.replace("/"));}else c("\u932F\u8AA4",`\u672A\u77E5\u7684\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66
\u82E5\u554F\u984C\u6301\u7E8C\u767C\u751F\uFF0C\u8ACB\u806F\u7D61\u7BA1\u7406\u54E1`);}};var T;(T=document.getElementById("form-login"))==null||T.addEventListener("submit",t=>{t.preventDefault();let e=s("input-username"),n=s("input-password");axios.post("/api/users/login",{username:e.value,password:n.value}).then(()=>{window.location.replace("/search");}).catch(u.failed({401:"\u7121\u6548\u7684\u4F7F\u7528\u8005\u540D\u7A31\u6216\u5BC6\u78BC"}));});var H;(H=document.getElementById("button-logout"))==null||H.addEventListener("click",()=>{axios.get("/api/users/logout").catch().finally(()=>{window.location.replace("/");});});var $;($=document.getElementById("form-search"))==null||$.addEventListener("submit",t=>{t.preventDefault();let e=s("input-search"),n=s("search-result");axios.get(`/api/donors/records/${e.value}`).then(o=>{n.value=o.data.data.toFixed();}).catch(u.failed({404:`\u300C${e.value}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));});var D;(D=document.getElementById("form-superior"))==null||D.addEventListener("submit",t=>{t.preventDefault();let e=s("input-superior"),n=s("input-inferior"),o=s("button-superior");e.disabled?(e.disabled=false,n.disabled=true,o.className="btn btn-warning",o.innerText="\u78BA\u8A8D"):(e.disabled=true,n.disabled=false,o.className="btn btn-danger",o.innerText="\u8B8A\u66F4",X(e.value).catch(u.failed({404:d=>(o.click(),`\u300C${d.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`)})));});var M;(M=document.getElementById("form-inferior"))==null||M.addEventListener("submit",t=>{t.preventDefault();let e=s("input-superior"),n=s("input-inferior");if(n.value===e.value){c("\u932F\u8AA4","\u7737\u5C6C\u4E0D\u53EF\u8207\u529F\u5FB7\u4E3B\u76F8\u540C");return}let o=null;t.submitter.name==="update"&&(o=e.value),axios.put(`/api/donors/relations/${n.value}`,{superior:o}).then(()=>X(e.value)).catch(u.failed({404:d=>`\u300C${d.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));});var X=t=>f(null,null,function*(){return axios.get(`/api/donors/relations/${t}`).then(e=>f(null,null,function*(){let n=["graph TD",...e.data.data.map(i=>i[0]?`${i[0].replace(/\s/g,"")}(${i[0]}) --> ${i[1].replace(/\s/g,"")}(${i[1]})`:`${i[1].replace(/\s/g,"")}(${i[1]})`)],{svg:o}=yield mermaid.render("graphDiv",n.join(`
`));s("mermaid").innerHTML=o;let d=(e.data.data.length>1?e.data.data.slice(1):e.data.data).map((i,m)=>[m+1,...i[0]?i:[i[1],""]]);s("tbody-relation").innerHTML=XLSX.utils.sheet_to_html(XLSX.utils.aoa_to_sheet(d));}))});var N;(N=document.getElementById("form-upload"))==null||N.addEventListener("submit",t=>f(null,null,function*(){var m;t.preventDefault();let e=s("input-file"),n=s("button-upload");n.disabled=true;let o=Array.from((m=e.files)!=null?m:[]).map(r=>[r.name,r.arrayBuffer()]).map(p=>f(null,[p],function*([r,a]){var A;let x=XLSX.read(yield a),E=x.Sheets[x.SheetNames[0]],g=XLSX.utils.decode_range((A=E["!ref"])!=null?A:""),P=Array.from({length:g.e.c-g.s.c+1},(l,I)=>E[XLSX.utils.encode_cell({r:g.s.r,c:g.s.c+I})]).map(l=>l==null?void 0:l.v),v=["\u4F9B\u990A\u8005","\u91D1\u984D"].filter(l=>!P.includes(l));if(v.length>0)return {type:"INVALID_HEADER",file:r,error:v};let h=[],y=XLSX.utils.sheet_to_json(E).map(l=>[l.\u4F9B\u990A\u8005?String(l.\u4F9B\u990A\u8005).trim():"",l.\u91D1\u984D?Number(l.\u91D1\u984D):NaN]).filter((l,I)=>{let b=["\u4F9B\u990A\u8005","\u91D1\u984D"].filter((S,w)=>[L=>L.length===0,L=>isNaN(L)][w](l[w]));return b.length===1&&h.push({line:I+2,missing:b}),b.length===0});return h.length>0?{type:"INVALID_DATA",file:r,error:h}:{type:"PENDING",file:r,count:y.length,data:y}})),d=yield Promise.all(o),i=d.filter(r=>r.type==="PENDING").map(r=>r.data).flat();axios.post("/api/donors/records",i).then(()=>{let r=d.map(a=>{switch(a.type){case "PENDING":return `\u6210\u529F\uFF08${a.file}\uFF09
\u3000\u532F\u5165 ${a.count.toFixed()} \u7B46\u7D00\u9304`;case "INVALID_HEADER":return `\u5931\u6557\uFF08${a.file}\uFF09
\u3000\u7F3A\u5C11\u6A19\u982D\u300C${a.error.join("\u3001")}\u300D`;case "INVALID_DATA":return `\u5931\u6557\uFF08${a.file}\uFF09
${a.error.map(p=>`\u3000\u7F3A\u5C11\u6B04\u4F4D\uFF1A\u7B2C ${p.line.toFixed()} \u5217\u300C${p.missing.join("\u3001")}\u300D`).join(`
`)}`}});c("\u4E0A\u50B3\u7D50\u679C",r.join(`
`));}).catch(u.failed()).finally(()=>{n.disabled=false;});}));var R;(R=document.getElementById("button-export"))==null||R.addEventListener("click",()=>{axios.get("/api/donors/records").then(t=>{let e=XLSX.utils.book_new(),n=XLSX.utils.aoa_to_sheet([["\u4F9B\u990A\u8005","\u91D1\u984D"],...t.data.data]);XLSX.utils.book_append_sheet(e,n,"\u6350\u6B3E\u7D71\u8A08"),XLSX.writeFile(e,`${Date.now().toFixed()}.xlsx`);}).catch(u.failed());});var _;(_=document.getElementById("button-delete"))==null||_.addEventListener("click",()=>{axios.delete("/api/donors").then(t=>setTimeout(()=>{c("\u6210\u529F",["\u6210\u529F\u522A\u9664\u8CC7\u6599\uFF1A",`\u3000\u6350\u6B3E\u4EBA ${t.data.data.donors.toFixed()} \u4EBA`,`\u3000\u6350\u6B3E\u7D00\u9304 ${t.data.data.records.toFixed()} \u7B46`].join(`
`));},200)).catch(u.failed());});document.addEventListener("hide.bs.modal",()=>{document.activeElement&&document.activeElement.blur();});