var m=(t,e,n)=>new Promise((s,d)=>{var i=o=>{try{r(n.next(o));}catch(p){d(p);}},f=o=>{try{r(n.throw(o));}catch(p){d(p);}},r=o=>o.done?s(o.value):Promise.resolve(o.value).then(i,f);r((n=n.apply(t,e)).next());});var a=t=>{let e=document.getElementById(t);if(!e)throw new Error(`Element with id "${t}" not found`);return e},c=(t,e)=>{let n=a("modal-title"),s=a("modal-content");n.innerText=t,s.innerHTML=e,document.getElementsByClassName("modal-backdrop fade show").length||(new bootstrap.Modal("#modal").show(),setTimeout(()=>{a("modal-button").focus();},200));},u={success:t=>{c("\u6210\u529F",t.data.data);},failed:t=>e=>{var n;if(axios.isAxiosError(e)&&e.response&&(t!=null&&t[e.response.status])){let s=t[e.response.status];s instanceof Function?c("\u932F\u8AA4",s(e.response.data)):c("\u932F\u8AA4",s);}else ((n=e.response)==null?void 0:n.status)===401?(alert("\u767B\u5165\u903E\u6642\uFF0C\u8ACB\u91CD\u65B0\u767B\u5165"),window.location.replace("/")):c("\u932F\u8AA4",`\u672A\u77E5\u7684\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66
\u82E5\u554F\u984C\u6301\u7E8C\u767C\u751F\uFF0C\u8ACB\u806F\u7D61\u7BA1\u7406\u54E1`);}};var $;($=document.getElementById("form-login"))==null||$.addEventListener("submit",t=>{t.preventDefault();let e=a("input-username"),n=a("input-password");axios.post("/api/user/login",{username:e.value,password:n.value}).then(()=>{window.location.replace("/search");}).catch(u.failed({401:"\u7121\u6548\u7684\u4F7F\u7528\u8005\u540D\u7A31\u6216\u5BC6\u78BC"}));});var D;(D=document.getElementById("button-logout"))==null||D.addEventListener("click",()=>{axios.get("/api/user/logout").catch().finally(()=>{window.location.replace("/");});});var H;(H=document.getElementById("form-search"))==null||H.addEventListener("submit",t=>{t.preventDefault();let e=a("input-search"),n=a("search-result");axios.get(`/api/donorRecords/search/${e.value}`).then(s=>{n.value=s.data.data.toFixed();}).catch(u.failed({404:`\u300C${e.value}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));});var M;(M=document.getElementById("form-superior"))==null||M.addEventListener("submit",t=>{t.preventDefault();let e=a("input-superior"),n=a("input-inferior"),s=a("button-superior");e.disabled?(e.disabled=false,n.disabled=true,s.className="btn btn-warning",s.innerText="\u78BA\u8A8D"):(e.disabled=true,n.disabled=false,s.className="btn btn-danger",s.innerText="\u8B8A\u66F4",L(e.value).catch(u.failed({404:d=>(s.click(),`\u300C${d.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`)})));});var R;(R=document.getElementById("form-inferior"))==null||R.addEventListener("submit",t=>{t.preventDefault();let e=a("input-superior"),n=a("input-inferior");if(n.value===e.value){c("\u932F\u8AA4","\u7737\u5C6C\u4E0D\u53EF\u8207\u529F\u5FB7\u4E3B\u76F8\u540C");return}let s={superior:e.value,inferior:n.value};switch(t.submitter.name){case "update":axios.post("/api/donorRelations",s).then(()=>L(e.value)).catch(u.failed({404:i=>`\u300C${i.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));break;case "delete":axios.delete(`/api/donorRelations/${n.value}`).then(()=>L(e.value)).catch(u.failed({404:i=>`\u300C${i.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));break}});var L=t=>m(void 0,null,function*(){return axios.get(`/api/donorRelations/${t}`).then(e=>m(void 0,null,function*(){let s=["graph TD",...e.data.data.map(i=>i.length===1?`${i[0].replace(/\s/g,"")}(${i[0]})`:`${i[0].replace(/\s/g,"")}(${i[0]}) --> ${i[1].replace(/\s/g,"")}(${i[1]})`)],{svg:d}=yield mermaid.render("graphDiv",s.join(`
`));a("mermaid").innerHTML=d;}))});var N;(N=document.getElementById("form-upload"))==null||N.addEventListener("submit",t=>m(void 0,null,function*(){var f;t.preventDefault();let e=a("input-file"),n=a("button-upload");n.disabled=true;let s=Array.from((f=e.files)!=null?f:[]).map(r=>[r.name,r.arrayBuffer()]).map(p=>m(void 0,[p],function*([r,o]){var A;let v=XLSX.read(yield o),h=v.Sheets[v.SheetNames[0]],g=XLSX.utils.decode_range((A=h["!ref"])!=null?A:""),X=Array.from({length:g.e.c-g.s.c+1},(l,I)=>h[XLSX.utils.encode_cell({r:g.s.r,c:g.s.c+I})]).map(l=>l==null?void 0:l.v),w=["\u4F9B\u990A\u8005","\u91D1\u984D"].filter(l=>!X.includes(l));if(w.length>0)return {type:"INVALID_HEADER",file:r,error:w};let E=[],y=XLSX.utils.sheet_to_json(h).map(l=>[l.\u4F9B\u990A\u8005?String(l.\u4F9B\u990A\u8005).trim():"",l.\u91D1\u984D?Number(l.\u91D1\u984D):NaN]).filter((l,I)=>{let b=["\u4F9B\u990A\u8005","\u91D1\u984D"].filter((B,T)=>[x=>x.length===0,x=>isNaN(x)][T](l[T]));return b.length===1&&E.push({line:I+2,missing:b}),b.length===0});return E.length>0?{type:"INVALID_DATA",file:r,error:E}:{type:"PENDING",file:r,count:y.length,data:y}})),d=yield Promise.all(s),i=d.filter(r=>r.type==="PENDING").map(r=>r.data).flat();axios.post("/api/donorRecords/upload",i).then(()=>{let r=d.map(o=>{switch(o.type){case "PENDING":return `\u6210\u529F\uFF08${o.file}\uFF09
\u3000\u532F\u5165 ${o.count.toFixed()} \u7B46\u7D00\u9304`;case "INVALID_HEADER":return `\u5931\u6557\uFF08${o.file}\uFF09
\u3000\u7F3A\u5C11\u6A19\u982D\u300C${o.error.join("\u3001")}\u300D`;case "INVALID_DATA":return `\u5931\u6557\uFF08${o.file}\uFF09
${o.error.map(p=>`\u3000\u7F3A\u5C11\u6B04\u4F4D\uFF1A\u7B2C ${p.line.toFixed()} \u5217\u300C${p.missing.join("\u3001")}\u300D`).join(`
`)}`}});c("\u4E0A\u50B3\u7D50\u679C",r.join(`
`));}).catch(u.failed()).finally(()=>{n.disabled=false;});}));var P;(P=document.getElementById("button-export"))==null||P.addEventListener("click",()=>{axios.get("/api/donorRecords/export").then(t=>{let e=XLSX.utils.book_new(),n=XLSX.utils.aoa_to_sheet([["\u4F9B\u990A\u8005","\u91D1\u984D"],...t.data.data]);XLSX.utils.book_append_sheet(e,n,"\u6350\u6B3E\u7D71\u8A08"),XLSX.writeFile(e,`${Date.now().toFixed()}.xlsx`);}).catch(u.failed());});var S;(S=document.getElementById("button-delete"))==null||S.addEventListener("click",()=>{axios.delete("/api/donor").then(t=>setTimeout(()=>{c("\u6210\u529F",["\u6210\u529F\u522A\u9664\u8CC7\u6599\uFF1A",`\u3000\u6350\u6B3E\u4EBA ${t.data.data.donors.toFixed()} \u4EBA`,`\u3000\u6350\u6B3E\u7D00\u9304 ${t.data.data.records.toFixed()} \u7B46`].join(`
`));},200)).catch(u.failed());});