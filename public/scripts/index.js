var o=t=>{let e=document.getElementById(t);if(!e)throw new Error(`Element with id "${t}" not found`);return e},l=(t,e)=>{let n=o("modal-title"),a=o("modal-content");n.innerText=t,a.innerHTML=e,document.getElementsByClassName("modal-backdrop fade show").length||(new bootstrap.Modal("#modal").show(),setTimeout(()=>{o("modal-button").focus();},200));},r={success:t=>{l("\u6210\u529F",t.data.data);},failed:t=>e=>{if(axios.isAxiosError(e)&&e.response&&t?.[e.response.status]){let n=t[e.response.status];n instanceof Function?l("\u932F\u8AA4",n(e.response.data)):l("\u932F\u8AA4",n);}else e.response?.status===401?(alert("\u767B\u5165\u903E\u6642\uFF0C\u8ACB\u91CD\u65B0\u767B\u5165"),window.location.replace("/")):l("\u932F\u8AA4",`\u672A\u77E5\u7684\u932F\u8AA4\uFF0C\u8ACB\u7A0D\u5F8C\u518D\u8A66
\u82E5\u554F\u984C\u6301\u7E8C\u767C\u751F\uFF0C\u8ACB\u806F\u7D61\u7BA1\u7406\u54E1`);}};document.getElementById("form-login")?.addEventListener("submit",t=>{t.preventDefault();let e=o("input-username"),n=o("input-password");axios.post("/api/user/login",{username:e.value,password:n.value}).then(()=>{window.location.replace("/search");}).catch(r.failed({401:"\u7121\u6548\u7684\u4F7F\u7528\u8005\u540D\u7A31\u6216\u5BC6\u78BC"}));});document.getElementById("button-logout")?.addEventListener("click",()=>{axios.get("/api/user/logout").catch().finally(()=>{window.location.replace("/");});});document.getElementById("form-search")?.addEventListener("submit",t=>{t.preventDefault();let e=o("input-search"),n=o("search-result");axios.get(`/api/donorRecords/search/${e.value}`).then(a=>{n.value=a.data.data.toFixed();}).catch(r.failed({404:`\u300C${e.value}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));});document.getElementById("form-superior")?.addEventListener("submit",t=>{t.preventDefault();let e=o("input-superior"),n=o("input-inferior"),a=o("button-superior"),i=()=>{e.disabled?(e.disabled=false,n.disabled=true,a.className="btn btn-warning",a.innerText="\u78BA\u8A8D"):(e.disabled=true,n.disabled=false,a.className="btn btn-danger",a.innerText="\u8B8A\u66F4",u(e.value).catch(r.failed({404:s=>(i(),`\u300C${s.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`)})));};i();});document.getElementById("form-inferior")?.addEventListener("submit",t=>{t.preventDefault();let e=o("input-superior"),n=o("input-inferior");if(n.value===e.value){l("\u932F\u8AA4","\u7737\u5C6C\u4E0D\u53EF\u8207\u529F\u5FB7\u4E3B\u76F8\u540C");return}let a={superior:e.value,inferior:n.value};switch(t.submitter.name){case "update":axios.post("/api/donorRelations",a).then(()=>u(e.value)).catch(r.failed({404:s=>`\u300C${s.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));break;case "delete":axios.delete(`/api/donorRelations/${n.value}`).then(()=>u(e.value)).catch(r.failed({404:s=>`\u300C${s.error.message}\u300D\u4E0D\u5728\u8CC7\u6599\u5EAB\u4E2D`}));break}});var u=async t=>axios.get(`/api/donorRelations/${t}`).then(async e=>{let a=["graph TD",...e.data.data.map(s=>s.length===1?`${s[0].replace(/\s/g,"")}(${s[0]})`:`${s[0].replace(/\s/g,"")}(${s[0]}) --> ${s[1].replace(/\s/g,"")}(${s[1]})`)],{svg:i}=await mermaid.render("graphDiv",a.join(`
`));o("mermaid").innerHTML=i;});document.getElementById("form-upload")?.addEventListener("submit",t=>{t.preventDefault();let e=o("input-file"),n=o("button-upload"),a=new FormData;for(let i of e.files??[])a.append("files",i);n.disabled=true,axios.post("/api/donorRecords/upload",a).then(i=>{let s=i.data.data.map(d=>{switch(d.type){case "SUCCESS":return `\u6210\u529F\uFF08${d.file}\uFF09
\u3000\u532F\u5165 ${d.count.toFixed()} \u7B46\u7D00\u9304`;case "MISSING_HEADER":return `\u5931\u6557\uFF08${d.file}\uFF09
\u3000\u7F3A\u5C11\u6A19\u982D\u300C${d.error.join("\u3001")}\u300D`;case "INVALID_DATA":return `\u5931\u6557\uFF08${d.file}\uFF09
${d.error.map(c=>`\u3000\u7F3A\u5C11\u6B04\u4F4D\uFF1A\u7B2C ${c.line.toFixed()} \u5217\u300C${c.missing.join("\u3001")}\u300D`).join(`
`)}`}});l("\u4E0A\u50B3\u7D50\u679C",s.join(`
`));}).catch(r.failed()).finally(()=>{n.disabled=false;});});document.getElementById("button-export")?.addEventListener("click",()=>{axios.get("/api/donorRecords/export",{responseType:"blob"}).then(t=>{let e=document.createElement("a");e.href=URL.createObjectURL(t.data),e.download=`${Date.now().toFixed()}.xlsx`,e.click();}).catch(r.failed());});document.getElementById("button-delete")?.addEventListener("click",()=>{axios.delete("/api/donor").then(t=>{l("\u6210\u529F",["\u6210\u529F\u522A\u9664\u8CC7\u6599\uFF1A",`\u3000\u6350\u6B3E\u4EBA ${t.data.data.donors.toFixed()} \u4EBA`,`\u3000\u6350\u6B3E\u7D00\u9304 ${t.data.data.records.toFixed()} \u7B46`].join(`
`));}).catch(r.failed());});